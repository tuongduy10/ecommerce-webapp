@using Microsoft.Extensions.Configuration
@using ECommerce.Application.Services.Configurations;
@inject IConfiguration Configuration
@inject IConfigurationService _configurationService
@{
    Layout = "~/Views/Shared/_LayoutClientNoBanner.cshtml";
    var config = await _configurationService.getConfiguration();
}

<!-- Main contain -->
<div class="custom-container">
    <div class="content__wrapper products__content-wrapper">
        <div class="content__inner w-100 pb-0">
            <ul class="web__directional">
                <li>
                    <a href="/">Trang chủ</a>
                </li>
                <li>
                    <a href="@Url.Action("ProductInBrand", "Product", new { BrandId = Model.product.BrandId, PageIndex = 1})">@Model.product.BrandName</a>
                </li>
                <li>
                    <a href="">@Model.product.ProductName</a>
                </li>
            </ul>
            <div class="product__detail-content">
                <div class="row no-gutters">
                    <div class="product__detail-image col-md-5">
                        <div class="product__detail-card">
                            <div class="product__detail-slider mb-2">
                                <ul class="lightSlider h-100">
                                    @if (Model.product.ProductImages.Count > 0)
                                    {
                                        @foreach (var img in Model.product.ProductImages)
                                        {
                                            <li class="h-100" data-thumb="@(Configuration["ImagePath:Product"] + img)">
                                                <img class="pop h-100" src="@(Configuration["ImagePath:Product"] + img)" />
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.product.SizeGuide))
                            {
                                <a class="product__detail-link" style="text-decoration: underline; cursor: pointer;" data-toggle="modal"
                                   data-target="#sizeguideModal">
                                    Hướng dẫn chọn size
                                </a>
                            }
                        </div>
                    </div>
                    <div class="product__detail-info col-md-7">
                        <div class="product__detail-card">
                            <div class="about">
                                <div class="product__detail-id d-flex flex-wrap align-items-center">
                                    <a class="product-id d-flex">
                                        <span>Mã sản phẩm:</span>
                                        <span>@Model.product.PPC</span>
                                    </a>
                                    <a class="product-rating d-flex">
                                        <div class="stars">
                                            @for (int i = 0; i < Model.product.ProductRate.Value; i++)
                                            {
                                                <span class="fa fa-star checked"></span>
                                            }
                                            @if (Model.product.ProductRate.Value != 5)
                                            {
                                                for (int i = 0; i < 5 - Model.product.ProductRate.Value; i++)
                                                {
                                                    <span class="fa fa-star"></span>
                                                }
                                            }
                                        </div>
                                        <u style="cursor: pointer;">@Model.product.ProductRate.Total Đánh giá</u>
                                    </a>
                                </div>
                                <div class="d-flex mb-4">
                                    <div class="w-50">
                                        <a class="product__detail-action" href="tel: @Model.phone">
                                            <span class="icon mr-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                     viewBox="0 0 24 24" fill="none" stroke="#333"
                                                     stroke-width="1" stroke-linecap="round"
                                                     stroke-linejoin="round" class="feather feather-phone">
                                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                                    </path>
                                                </svg>
                                            </span>
                                            <span class="text">@Model.phone</span>
                                        </a>
                                    </div>
                                    <div class="w-50">
                                        <a class="product__detail-action">
                                            <span class="icon mr-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                     viewBox="0 0 24 24" fill="none" stroke="#333"
                                                     stroke-width="1" stroke-linecap="round"
                                                     stroke-linejoin="round" class="feather feather-heart">
                                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                                    </path>
                                                </svg>
                                            </span>
                                            <span class="text">Yêu Thích</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="product__detail-name">@Model.product.ProductName</div>
                                <div class="product__detail-brand">
                                    <a>@Model.product.ShopName</a>
                                </div>
                                @if (Model.product.ProductImportDate != null)
                                {
                                    <div class="product__detail-brand">
                                        <span style="font-size: calc(16px + (20 - 14) * ((100vw - 375px)/ (1920 - 375)));">
                                            Tạm hết đến ngày @Model.product.ProductImportDate.ToString("dd/MM/yyyy")
                                        </span>
                                    </div>
                                }

                                <!-- Description -->
                                <div class="product__detail-desciption">
                                    <div class="bullets">
                                        @if (Model.product.Legit == true)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="mr-2">
                                                    <img src="/images/icon/medal.png" alt="">
                                                </span>
                                                <span class="bullet-text">Sản phẩm chính hãng</span>
                                            </div>
                                        }
                                        @if (Model.product.Insurance != "")
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="mr-2">
                                                    <img src="/images/icon/baohanh.png" alt="">
                                                </span>
                                                <span class="bullet-text">@Model.product.Insurance</span>
                                            </div>
                                        }
                                        @if (Model.product.FreeReturn == true)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="mr-2">
                                                    <img src="/images/icon/return.png" alt="">
                                                </span>
                                                <span class="bullet-text">Đổi trả miễn phí</span>
                                            </div>
                                        }
                                        @if (Model.product.FreeDelivery == true)
                                        {
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="mr-2">
                                                    <img src="/images/icon/giaohang.png" alt="">
                                                </span>
                                                <span class="bullet-text">Giao hàng miễn phí</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="product__detail-bottom">
                                <!-- Product options -->
                                <div class="product__detail-options">
                                    <div class="option-quality d-flex mb-2 align-items-center">
                                        <div class="option-title">Chọn số lượng</div>
                                        <input class="text-center mr-2 pro-qty" type="number" value="1" min="1" max="999" onkeyup="if(this.value > 999) this.value = 999;">
                                        @*<a class="product__detail-link" style="text-decoration: underline; cursor: pointer;" data-toggle="modal"
                                               data-target="#wholesaleModal">
                                                Xem giá mua sỉ
                                            </a>*@
                                    </div>
                                    @foreach (var option in Model.options)
                                    {
                                        <div class="option-size d-flex mb-2 align-items-center">
                                            <div class="option-title">@option.name</div>
                                            <div class="options-wrapper">
                                                <select class="options form-select w-100 pro-options"
                                                        aria-label="Default select example">
                                                    <option disabled selected>- Chọn -</option>
                                                    @foreach (var value in option.values)
                                                    {
                                                        <option value="@value">@value</option>
                                                    }
                                                </select>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                     viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="feather feather-chevron-down">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </div>
                                        </div>

                                    }
                                </div>
                                <!-- Product price -->
                                <div class="product__detail-price">
                                    @if (Model.product.DiscountPercent != null)
                                    {
                                        <span class="sales-value">Giảm @Model.product.DiscountPercent%</span>
                                    }

                                    @foreach (var item in Model.product.Prices)
                                    {
                                        if (item.ProductTypeId == 1 && item.Price != null)
                                        {
                                            <div class="option-price form-check form-check-inline w-100">
                                                <div class="option-title">
                                                    <input class="form-check-input" type="radio"
                                                           name="pro-type" id="inlineRadio1" value="1">
                                                    <label class="form-check-label" for="inlineRadio1">
                                                        Có sẵn
                                                    </label>
                                                </div>
                                                <label class="form-check-label d-flex align-items-center"
                                                       for="inlineRadio1">
                                                    @if (item.PriceOnSell != null)
                                                    {
                                                        <span class="price mr-2">@String.Format("{0:0,0} ₫", item.PriceOnSell)</span>
                                                        <span class="saleprice">
                                                            <strike>@String.Format("{0:0,0} ₫", item.Price)</strike>
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="price mr-2">@String.Format("{0:0,0} ₫", item.Price)</span>
                                                    }
                                                </label>
                                            </div>
                                        }
                                        if (item.ProductTypeId == 2 && item.Price != null)
                                        {
                                            <div class="option-price form-check form-check-inline w-100">
                                                <div class="option-title">
                                                    <input class="form-check-input" type="radio"
                                                           name="pro-type" id="inlineRadio2" value="2">
                                                    <label class="form-check-label" for="inlineRadio2">
                                                        Đặt trước
                                                    </label>
                                                </div>
                                                <label class="form-check-label d-flex align-items-center"
                                                       for="inlineRadio2">
                                                    @if (item.PriceOnSell != null)
                                                    {
                                                        <span class="price mr-2">@String.Format("{0:0,0} ₫", item.PriceOnSell)</span>
                                                        <span class="saleprice">
                                                            <strike>@String.Format("{0:0,0} ₫", item.Price)</strike>
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="price mr-2">@String.Format("{0:0,0} ₫", item.Price)</span>
                                                    }
                                                </label>
                                            </div>
                                        }
                                    }
                                    <!-- Discount -->
                                    @if (Model.discount != null)
                                    {
                                        <div class="mt-2">
                                            <div class="product__sale-code w-100 justify-content-between d-flex align-items-center">
                                                <span class="circle-left"></span>
                                                <div class="product__sale-content">
                                                    @if (Model.discount.IsPercent)
                                                    {
                                                        <div class="text">
                                                            Nhập mã <strong>@Model.discount.DiscountCode</strong> giảm @Model.discount.DiscountValue%
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="text">
                                                            Nhập mã <strong>@Model.discount.DiscountCode</strong> giảm @String.Format("{0:0,0} ₫", Model.discount.DiscountValue)
                                                        </div>
                                                    }
                                                </div>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                     viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="feather feather-chevron-down">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                                <span class="circle-right"></span>
                                            </div>
                                            <div class="product__sale-bottom d-none">
                                                <div class="d-flex align-items-center justify-content-between my-2">
                                                    @if (Model.discount.IsPercent)
                                                    {
                                                        <div class="text">
                                                            Nhập <strong class="salecode">@Model.discount.DiscountCode</strong> để giảm @Model.discount.DiscountValue % trên tổng hóa đơn
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="text">
                                                            Nhập <strong class="salecode">@Model.discount.DiscountCode</strong> để giảm @String.Format("{0:0,0} ₫", Model.discount.DiscountValue) trên tổng hóa đơn
                                                        </div>
                                                    }
                                                    <button type="button" class="getcode" style="white-space: nowrap">Lấy mã</button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <!-- Action -->
                                <div class="product__detail-buttons d-flex justify-content-between w-100">
                                    <button class="btn-addtocart btn-black"
                                            style="width: 49%; background-color: #333; color: #fff;">
                                        Thêm vào giỏ
                                    </button>
                                    <button class="btn-buynow btn-black" onclick="window.location.href='cart.html'"
                                            style="width: 49%; background-color: #333; color: #fff;">
                                        Mua ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Product user images -->
            @if (Model.product.ProductUserImages.Count > 0)
            {
                <div class="product__images-slider">
                    <h1 class="detail-title mb-0"><strong>HÌNH ẢNH THỰC TẾ</strong></h1>
                    <hr class="mt-0">
                    <ul id="content-slider">
                        @foreach (var item in Model.product.ProductUserImages)
                        {
                            <li>
                                <img class="pop" src="@(Configuration["ImagePath:Product"] + item)" alt="">
                            </li>
                        }
                    </ul>
                </div>
            }
            <!-- Attributes and desciption -->
            <div class="product__detail-tab">
                <div class="product__tab-control">
                    <ul class="d-flex justify-content-around">
                        <li class="mx-2">
                            <a class="control-tab detail-title control__tab-info">Thông tin sản phẩm</a>
                        </li>
                        <li class="mx-2">
                            <a class="control-tab detail-title control__tab-comment active">Đánh giá sản phẩm</a>
                        </li>
                    </ul>
                </div>
                <div class="product__tab-content">
                    <div class="content-tab tab__product-info">
                        <div class="product-detail">
                            <ul class="detail-list d-flex mb-4 flex-wrap justify-content-between">
                                @foreach (var attr in Model.product.Attributes)
                                {
                                    if (!string.IsNullOrEmpty(attr.Value))
                                    {
                                        <li class="detail-item">
                                            <span><b>@attr.AttrName</b></span>
                                            <span>@attr.Value</span>
                                        </li>
                                    }
                                }
                            </ul>
                            <div class="title">Mô tả ngắn</div>
                            <div class="description">
                                @Html.Raw(Model.product.ProductDescription)
                            </div>
                            <div class="description-mobile">
                                @Html.Raw(Model.product.ProductDescriptionMobile)
                            </div>
                        </div>
                    </div>
                    <div class="content-tab tab__product-comment active">
                        <!-- Rate -->
                        <div class="product-comment">
                            @if (!User.Identity.IsAuthenticated)
                            {
                                <div class="text-center mb-4">
                                    <button class="d-flex mx-auto" onclick="window.location.href = '@Url.Action("SignIn", "Account", new { CurrentUrl = Context.Request.Path + Context.Request.QueryString})'">
                                        <span style="height: 24px; margin-right: 10px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1"
                                                 stroke-linecap="round" stroke-linejoin="round"
                                                 class="feather feather-edit-3">
                                                <path d="M12 20h9"></path>
                                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z">
                                                </path>
                                            </svg>
                                        </span>
                                        <span>Viết bình luận</span>
                                    </button>
                                </div>
                            }
                            @if (User.Identity.IsAuthenticated)
                            {
                                <div class="tab__content-block">
                                    <div class="d-flex">
                                        <span class="input-title mx-auto">VIẾT NHẬN XÉT CỦA BẠN BÊN DƯỚI</span>
                                    </div>
                                    <div class="rating d-flex mb-2 align-items-center">
                                        <span>Đánh giá</span>
                                        <div class="stars ml-2">
                                            <span class="rate-value fa fa-star checked"></span>
                                            <span class="rate-value fa fa-star checked"></span>
                                            <span class="rate-value fa fa-star checked"></span>
                                            <span class="rate-value fa fa-star checked"></span>
                                            <span class="rate-value fa fa-star checked"></span>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <textarea class="comment-val d-flex w-100 mb-2" name="" id=""
                                                  placeholder="Nhận xét của bạn về sản phẩm này"></textarea>
                                    </div>
                                    <div class="upload-image mb-2">
                                        <label for="image-upload" class="input-tile mb-2">
                                            <a class="upload">Chọn ảnh</a>
                                            <span>Thêm hình ảnh sản phẩm nếu có (Tối đa 3)</span>
                                        </label>
                                        <input id="image-upload" type="file" multiple hidden />
                                        <output class="d-flex" id="image-preview">
                                        </output>
                                    </div>
                                    <div class="text-right">
                                        <button class="post-comment" type="button">Gửi bình luận</button>
                                    </div>
                                </div>
                            }
                            <div class="tab__content-block d-block">
                                @foreach (var rate in Model.rates)
                                {
                                    <!-- Comment level 1 -->
                                    <div class="user-comment user-comment-@rate.Id mb-4">
                                        <!-- User lv1 -->
                                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="user__comment-name mr-2">
                                                    <strong>@rate.UserName</strong>
                                                </span>
                                                @if (rate.IsAdmin)
                                                {
                                                    <span class="user__comment-role px-1 mr-2" style="white-space: nowrap">Quản trị viên</span>
                                                }
                                                else
                                                {
                                                    <img class="verifyImg" width="15" height="15" src="~/images/icon/verify.png">
                                                    <span class="verify" style="font-size: calc(12px + (16 - 14) * ((100vw - 375px)/ (1920 - 375))) !important; color: #4caf50;">Đã mua hàng</span>
                                                }
                                            </div>
                                            <span class="user__comment-time ml-2 mb-2" style="white-space: nowrap;">@rate.CreateDate.ToString("HH:mm, dd/MM/yyyy")</span>
                                        </div>
                                        <!-- Star lv1 -->
                                        <div class="d-flex stars star-@rate.Id">
                                            @if (rate.Value != 0)
                                            {
                                                @for (int i = 0; i < rate.Value; i++)
                                                {
                                                    <span class="fa fa-star checked"></span>
                                                }
                                                for (int i = 0; i < 5 - rate.Value; i++)
                                                {
                                                    <span class="fa fa-star"></span>
                                                }
                                            }
                                        </div>
                                        <!-- Comment lv1 -->
                                        <div class="comment comment-@rate.Id my-2">
                                            @rate.Comment
                                        </div>
                                        <!-- Update info lv1 -->
                                        <div class="update-comment update-comment-@rate.Id my-2 d-none">
                                            <!-- Update star lv1 -->
                                            <div class="rating d-flex mb-2 align-items-center">
                                                <span>Đánh giá</span>
                                                <div class="stars ml-2">
                                                    @for (int i = 0; i < rate.Value; i++)
                                                    {
                                                        <span class="rate-value-@rate.Id fa fa-star checked"></span>
                                                    }
                                                    @if (rate.Value != 5)
                                                    {
                                                        for (int i = 0; i < 5 - rate.Value; i++)
                                                        {
                                                            <span class="rate-value-@rate.Id fa fa-star"></span>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                            <!-- Update comment lv1 -->
                                            <textarea class="d-flex w-100 mb-2 comment-val-@rate.Id" name="" id="" placeholder="Bình luận">@rate.Comment</textarea>
                                            <!-- Update images lv1 -->
                                            <div class="text-left">
                                                <div class="upload-image mb-2">
                                                    <label for="image-upload-@rate.Id" class="input-tile mb-2">
                                                        <a class="upload">Chọn ảnh</a>
                                                        <span>Thêm hình ảnh nếu có (Tối đa 3)</span>
                                                    </label>
                                                    <input id="image-upload-@rate.Id" class="file-upload" type="file" multiple hidden onchange="handleUpload(event, 'image-preview-@rate.Id', @rate.Id)" />
                                                    <output class="images-uploaded d-flex" id="image-preview-@rate.Id">
                                                        @if (rate.Images.Count > 0)
                                                        {
                                                            @foreach (var img in rate.Images)
                                                            {
                                                                <div class="image__upload-item-@rate.Id mr-2">
                                                                    <div class="border mb-2 mx-auto" style="height: 100px; width: 100px;">
                                                                        <div class="image-wrapper w-100 h-100 position-relative d-flex align-items-center justify-content-center">
                                                                            <img class="mw-100 mh-100" src="@(Configuration["ImagePath:Rate"] + img.path)" alt="">
                                                                            <span class="position-absolute remove-upload"
                                                                                  style="right: 0; top: 0; cursor: pointer;" value="@img.id">
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                                                                     height="18" viewBox="0 0 24 24" fill="none"
                                                                                     stroke="red" stroke-width="1" stroke-linecap="round"
                                                                                     stroke-linejoin="round" class="feather feather-x">
                                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                                </svg>
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                    </output>
                                                </div>
                                            </div>
                                            <!-- Cancel/Update lv1 -->
                                            <div class="text-right">
                                                <button type="button" onclick="onCancelUpdate(@rate.Id)" style="background: unset; color: #333 !important;">Hủy</button>
                                                <button type="button" onclick="updateComment(@rate.Id)">Cập nhật</button>
                                            </div>
                                        </div>
                                        <!-- Images lv1 -->
                                        @if (rate.Images.Count > 0)
                                        {
                                            <div class="image images-comment images-comment-@rate.Id mb-2">
                                                <ul class="image-list d-flex">
                                                    @foreach (var img in rate.Images)
                                                    {
                                                        <li class="border image-@img.id">
                                                            <img class="pop" src="@(Configuration["ImagePath:Rate"] + img.path)" alt="">
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                        <!-- Answer/Like/Dislike/Cancel lv1 -->
                                        <div class="d-flex align-items-center mb-2 reply-action action-box action-box-@rate.Id">
                                            @if (!User.Identity.IsAuthenticated)
                                            {
                                                <a style="color: #288ad9; cursor: pointer;" onclick="window.location.href = '@Url.Action("SignIn", "Account", new { CurrentUrl = Context.Request.Path + Context.Request.QueryString})'"> Trả lời </a>
                                            }
                                            else
                                            {
                                                <a class="mr-2" style="color: #288ad9;" href="javascript:void(0)" onclick="userRepliedId = @rate.UserId; openReplyBox(@rate.Id)">Trả lời</a>
                                            }
                                            <!-- Like icon level 1 -->
                                            <a class="favor d-flex align-items-center"
                                               href="javascript:void(0)"
                                               style="cursor: default; margin-right: 5px; height: 18px;color: #288ad9;">
                                                <svg onclick="likeComment(@rate.Id)"
                                                     style="cursor: pointer;"
                                                     xmlns="http://www.w3.org/2000/svg" width="18"
                                                     height="18" viewBox="0 0 24 24"
                                                     @if (rate.Liked) { @Html.Raw("fill=\"#288ad9\"")  ; } else { @Html.Raw("fill=\"none\"")   ; }
                                                     stroke="currentColor" stroke-width="1.5"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="feather feather-thumbs-up like-svg-@rate.Id">
                                                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3">
                                                    </path>
                                                </svg>
                                                <span class="user__comment-time ml-2 like-@rate.Id count"
                                                      onclick="getUsersLike(@rate.Id)"
                                                      style="color: #707070;">
                                                    @rate.LikeCount
                                                </span>
                                            </a>
                                            <!-- Dislike icon level 1 -->
                                            <a class="favor d-flex align-items-center" 
                                               href="javascript:void(0)" 
                                               style="cursor: default; margin-right: 5px; height: 18px;color: #288ad9;">
                                                <svg onclick="dislikeComment(@rate.Id)"
                                                     style="cursor: pointer;"
                                                     xmlns="http://www.w3.org/2000/svg" width="18"
                                                     height="18" viewBox="0 0 24 24"
                                                     @if (rate.Disliked) { @Html.Raw("fill=\"#288ad9\"")  ; } else { @Html.Raw("fill=\"none\"") ; }
                                                     stroke="currentColor" stroke-width="1.5"
                                                     stroke-linecap="round" stroke-linejoin="round"
                                                     class="feather feather-thumbs-down dislike-svg-@rate.Id">
                                                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17">
                                                    </path>
                                                </svg>
                                                <span class="user__comment-time dislike-@rate.Id ml-2 count"
                                                      onclick="getUsersDislike(@rate.Id)"
                                                      style="color: #707070;">
                                                    @rate.DislikeCount
                                                </span>
                                            </a>
                                            @if (rate.CanAction)
                                            {
                                                <div style="position: relative;">
                                                    <a class="favor d-flex align-items-center" href="javascript:void(0)" onclick="onShowActionList(@rate.Id)" style="margin-right: 5px; height: 18px;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                             height="24" viewBox="0 0 24 24"
                                                             fill="none"
                                                             stroke="currentColor" stroke-width="2"
                                                             stroke-linecap="round" stroke-linejoin="round"
                                                             class="feather feather-more-horizontal"
                                                             style="border-radius: 50%; background: #ddd; border: 1px solid #ddd; padding: 3px;">
                                                            <circle cx="12" cy="12" r="1"></circle>
                                                            <circle cx="19" cy="12" r="1"></circle>
                                                            <circle cx="5" cy="12" r="1"></circle>
                                                        </svg>
                                                    </a>
                                                    <div class="action-list action-list-@rate.Id d-none"
                                                         style="position: absolute; width: 126px; background: #fff; border: 1px solid #ddd; border-radius: 10px; top: 24px; left: 5px; z-index: 1;">
                                                        <ul class="text-center">
                                                            <li class="border-bottom">
                                                                <a href="javascript:void(0)" style="color: var(--blue-dior);" onclick="showUpdateBox(@rate.Id)">Chỉnh sửa</a>
                                                            </li>
                                                            <li class="border-bottom">
                                                                <a href="javascript:void(0)" onclick="deleteComment(@rate.Id)" style="color: red;">Xóa</a>
                                                            </li>
                                                            <li style="">
                                                                <a href="javascript:void(0)" onclick="onShowActionList(@rate.Id)">Hủy</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        <!-- Reply box lv1 -->
                                        <div class="reply-box reply-box-@rate.Id reply-box-lv1-@rate.Id d-none">
                                            <div class="d-flex">
                                                <textarea class="d-flex w-100 mb-2 rep-comment-val-lv1-@rate.Id" name="" id="" placeholder="Bình luận"></textarea>
                                            </div>
                                            <div class="text-left">
                                                <div class="upload-image mb-2">
                                                    <label for="image-upload-reply-@rate.Id" class="input-tile mb-2">
                                                        <a class="upload">Chọn ảnh</a>
                                                        <span>Thêm hình ảnh nếu có (Tối đa 3)</span>
                                                    </label>
                                                    <input id="image-upload-reply-@rate.Id" class="file-upload" type="file" multiple hidden onchange="handleUpload(event, 'image-reply-preview-@rate.Id')" />
                                                    <output class="images-uploaded d-flex" id="image-reply-preview-@rate.Id">
                                                    </output>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <button type="button" onclick="onCancelReply(@rate.Id)" style="background: unset; color: #333 !important;">Hủy</button>
                                                <button type="button" onclick="sendReply(@rate.Id)">Gửi</button>
                                            </div>
                                        </div>
                                        <!-- Reply level 2 -->
                                        @if (rate.Replies.Count > 0)
                                        {
                                            <div class="listreply listreply-@rate.Id mt-2">
                                                @foreach (var reply in rate.Replies)
                                                {
                                                    <div class="reply user-comment-@reply.Id mb-2">
                                                        <!-- User -->
                                                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                                                            <div class="d-flex align-items-center mb-2">
                                                                @if (reply.IsAdmin)
                                                                {
                                                                    <span class="user__comment-name d-flex align-items-center">
                                                                        <img class="mr-2" width="30" height="30" src="@(Configuration["ImagePath:Favicon"] + config.FaviconPath)">
                                                                        <strong>@reply.UserName</strong>
                                                                    </span>
                                                                    <span class="user__comment-role ml-2 px-1" style="white-space: nowrap">Quản trị viên</span>
                                                                }
                                                                else if (reply.IsShopOwner)
                                                                {
                                                                    <span class="user__comment-name d-flex align-items-center">
                                                                        <img class="mr-2" width="30" height="30" src="@(Configuration["ImagePath:User"] + "seller-icon.png")">
                                                                        <strong>@reply.UserName</strong>
                                                                    </span>
                                                                    <span class="user__comment-role ml-2 px-1" style="white-space: nowrap; background-color: var(--blue-dior);">Nhà bán hàng</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="user__comment-name d-flex align-items-center">
                                                                        <strong>@reply.UserName</strong>
                                                                    </span>
                                                                }
                                                            </div>
                                                            <span class="user__comment-time ml-2">@reply.CreateDate.ToString("HH:mm, dd/MM/yyyy")</span>
                                                        </div>
                                                        <!-- Comment level 2 -->
                                                        <div class="comment comment-@reply.Id my-2">
                                                            <span style="color: #288ad9;">@Html.Raw("@")@reply.UserRepliedName</span>
                                                            @reply.Comment
                                                        </div>
                                                        <!-- Update Info level 2 -->
                                                        <div class="update-comment update-comment-@reply.Id mb-2 d-none">
                                                            <textarea class="d-flex w-100 mb-2 comment-val-@reply.Id" name="" id="" placeholder="Bình luận">@reply.Comment</textarea>
                                                            <div class="text-left">
                                                                <div class="upload-image mb-2">
                                                                    <label for="image-upload-@reply.Id" class="input-tile mb-2">
                                                                        <a class="upload">Chọn ảnh</a>
                                                                        <span>Thêm hình ảnh nếu có (Tối đa 3)</span>
                                                                    </label>
                                                                    <input id="image-upload-@reply.Id" class="file-upload" type="file" multiple hidden onchange="handleUpload(event, 'image-preview-@reply.Id')" />
                                                                    <output class="images-uploaded d-flex" id="image-preview-@reply.Id">
                                                                        @if (rate.Images.Count > 0)
                                                                        {
                                                                            @foreach (var img in reply.Images)
                                                                            {
                                                                                <div class="image__upload-item-@reply.Id mr-2">
                                                                                    <div class="border mb-2 mx-auto" style="height: 100px; width: 100px;">
                                                                                        <div class="image-wrapper w-100 h-100 position-relative d-flex align-items-center justify-content-center">
                                                                                            <img class="mw-100 mh-100" src="@(Configuration["ImagePath:Rate"] + img.path)" alt="">
                                                                                            <span class="position-absolute remove-upload"
                                                                                                  style="right: 0; top: 0; cursor: pointer;" value="@img.id">
                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                                                                                     height="18" viewBox="0 0 24 24" fill="none"
                                                                                                     stroke="red" stroke-width="1" stroke-linecap="round"
                                                                                                     stroke-linejoin="round" class="feather feather-x">
                                                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                                                </svg>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            }
                                                                        }
                                                                    </output>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <button type="button" onclick="onCancelUpdate(@reply.Id)" style="background: unset; color: #333 !important;">Hủy</button>
                                                                <button type="button" onclick="updateComment(@reply.Id)">Cập nhật</button>
                                                            </div>
                                                        </div>
                                                        <!-- Reply images level 2 -->
                                                        @if (reply.Images.Count > 0)
                                                        {
                                                            <div class="image images-comment-@reply.Id mb-2">
                                                                <ul class="image-list d-flex">
                                                                    @foreach (var image in reply.Images)
                                                                    {
                                                                        <li class="border">
                                                                            <img class="pop" src="@(Configuration["ImagePath:Rate"] + image.path)" alt="">
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        }
                                                        <!-- Open reply box, Like, Dislike level 2 -->
                                                        <div class="d-flex align-items-center reply-action action-box action-box-@reply.Id">
                                                            <!-- Open reply box level 2 -->
                                                            @if (!User.Identity.IsAuthenticated)
                                                            {
                                                                <a onclick="window.location.href = '@Url.Action("SignIn", "Account", new { CurrentUrl = Context.Request.Path + Context.Request.QueryString})'" style="margin-right: 5px; color: #288ad9; cursor: pointer;">Trả lời</a>
                                                            }
                                                            else
                                                            {
                                                                <a href="javascript:void(0)" style="margin-right: 5px; color: #288ad9;" onclick="userRepliedId = @reply.UserId; openReplyBox(@reply.Id)">Trả lời</a>
                                                            }
                                                            <!-- Like icon level 2 -->
                                                            <a class="favor d-flex align-items-center" 
                                                               href="javascript:void(0)" 
                                                               style="cursor: default;margin-right: 5px; height: 18px;color: #288ad9;">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                                                     onclick="likeComment(@reply.Id)" 
                                                                     style="cursor: pointer;"
                                                                     height="18" viewBox="0 0 24 24"
                                                                     @if (reply.Liked) { @Html.Raw("fill=\"#288ad9\"")  ; } else { @Html.Raw("fill=\"none\"") ; }
                                                                     stroke="currentColor" stroke-width="1.5"
                                                                     stroke-linecap="round" stroke-linejoin="round"
                                                                     class="feather feather-thumbs-up like-svg-@reply.Id">
                                                                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3">
                                                                    </path>
                                                                </svg>
                                                                <span class="user__comment-time ml-2 like-@reply.Id count" 
                                                                      onclick="getUsersLike(@reply.Id)"
                                                                      style="color: #707070;">
                                                                    @reply.LikeCount
                                                                </span>
                                                            </a>
                                                            <!-- Dislike icon level 2 -->
                                                            <a class="favor d-flex align-items-center" 
                                                               href="javascript:void(0)" 
                                                               style="cursor: default;margin-right: 5px; height: 18px;color: #288ad9;">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                                                     onclick="dislikeComment(@reply.Id)" 
                                                                     style="cursor: pointer;"
                                                                     height="18" viewBox="0 0 24 24"
                                                                     @if (reply.Disliked) { @Html.Raw("fill=\"#288ad9\"")  ; } else { @Html.Raw("fill=\"none\"") ; }
                                                                     stroke="currentColor" stroke-width="1.5"
                                                                     stroke-linecap="round" stroke-linejoin="round"
                                                                     class="feather feather-thumbs-down dislike-svg-@reply.Id">
                                                                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17">
                                                                    </path>
                                                                </svg>
                                                                <span class="user__comment-time dislike-@reply.Id ml-2 count" 
                                                                      onclick="getUsersDislike(@reply.Id)"
                                                                      style="color: #707070;">
                                                                    @reply.DislikeCount
                                                                </span>
                                                            </a>
                                                            <!-- More icon level 2 -->
                                                            @if (reply.CanAction)
                                                            {
                                                                <div style="position: relative;">
                                                                    <a class="favor d-flex align-items-center" href="javascript:void(0)" onclick="onShowActionList(@reply.Id)" style="margin-right: 5px; height: 18px;">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                             height="24" viewBox="0 0 24 24"
                                                                             fill="none"
                                                                             stroke="currentColor" stroke-width="2"
                                                                             stroke-linecap="round" stroke-linejoin="round"
                                                                             class="feather feather-more-horizontal"
                                                                             style="border-radius: 50%; background: #ddd; border: 1px solid #ddd; padding: 3px;">
                                                                            <circle cx="12" cy="12" r="1"></circle>
                                                                            <circle cx="19" cy="12" r="1"></circle>
                                                                            <circle cx="5" cy="12" r="1"></circle>
                                                                        </svg>
                                                                    </a>
                                                                    <div class="action-list action-list-@reply.Id d-none" style="position: absolute;width: 126px;background: #fff;border: 1px solid #ddd;border-radius: 10px;top: 24px;left: 5px;">
                                                                        <ul class="text-center">
                                                                            <li class="border-bottom">
                                                                                <a href="javascript:void(0)" style="color: var(--blue-dior);" onclick="showUpdateBox(@reply.Id)">Chỉnh sửa</a>
                                                                            </li>
                                                                            <li class="border-bottom">
                                                                                <a href="javascript:void(0)" onclick="deleteComment(@reply.Id)" style="color: red;">Xóa</a>
                                                                            </li>
                                                                            <li style="">
                                                                                <a href="javascript:void(0)" onclick="onShowActionList(@reply.Id)">Hủy</a>
                                                                            </li>
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                        <!-- Reply box level 2 -->
                                                        <div class="reply-box reply-box-@reply.Id reply-box-lv2-@reply.Id d-none">
                                                            <div class="d-flex">
                                                                <textarea class="d-flex w-100 mb-2 rep-comment-val-lv2-@reply.Id" name="" id="" placeholder="Bình luận"></textarea>
                                                            </div>
                                                            <div class="text-left">
                                                                <div class="upload-image mb-2">
                                                                    <label for="image-upload-reply-@reply.Id" class="input-tile mb-2">
                                                                        <a class="upload">Chọn ảnh</a>
                                                                        <span>Thêm hình ảnh nếu có (Tối đa 3)</span>
                                                                    </label>
                                                                    <input id="image-upload-reply-@reply.Id" class="file-upload" type="file" multiple hidden onchange="handleUpload(event, 'image-reply-preview-@reply.Id')" />
                                                                    <output class="images-uploaded d-flex" id="image-reply-preview-@reply.Id">
                                                                    </output>
                                                                </div>
                                                            </div>
                                                            <div class="text-right">
                                                                <button type="button" onclick="onCancelReply(@reply.Id)" style="background: unset; color: #333 !important;">Hủy</button>
                                                                <button type="button" onclick="sendReplyLv2(@rate.Id, @reply.Id)">Gửi</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Suggestion products -->
            <div class="products__list mx-auto w-100">
                <h1 class="detail-title mb-0"><strong>GỢI Ý CHO BẠN</strong></h1>
                <hr class="my-0">
                <div class="product__grid-wrapper pb-0">
                    @if (Model.suggestion.Count > 0)
                    {
                        <div class="product__grid-inner product__grid-4 w-100 d-flex flex-wrap mb-2">
                            @foreach (var product in Model.suggestion)
                            {
                                <div class="product">
                                    <div class="product-label d-flex justify-content-end align-items-center w-100" style="background-color: #fff; padding: 3px 0; position: unset;">
                                        @if (product.DiscountPercent != null)
                                        {
                                            <span class="label-sales">-@product.DiscountPercent%</span>
                                        }
                                        @if (product.New == true)
                                        {
                                            <span class="label-new">Mới</span>
                                        }
                                        @if (product.Highlights == true)
                                        {
                                            <span class="label-hot">Hot</span>
                                        }
                                        <!--Add to wishlist-->
                                        <a class="product-heart" style="cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24" fill="none" stroke="#333"
                                                 stroke-width="1" stroke-linecap="round"
                                                 stroke-linejoin="round"
                                                 class="add-to-wishlist feather feather-heart">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                                </path>
                                            </svg>
                                        </a>
                                    </div>
                                    <a class="product-img" href="@Url.Action("ProductDetail", "Product", new { ProductId = product.ProductId })">
                                        <img src="@(Configuration["ImagePath:Product"] + product.ProductImages)" alt="">
                                    </a>
                                    <hr style="width: 50%; margin: 0 auto;">
                                    <div class="product__info">
                                        <div class="product__info-detail text-center">
                                            <div class="product-brand align-items-center">
                                                @product.ShopName
                                            </div>
                                            <div class="product-name mb-0">
                                                @product.ProductName
                                            </div>
                                            @if (product.ProductImportDate != null)
                                            {
                                                <div class="product-name">
                                                    Tạm hết đến @product.ProductImportDate.ToString("dd/MM/yyyy")
                                                </div>
                                            }
                                            @if (product.ProductImportDate == null)
                                            {
                                                <div class="product-name">
                                                    (@product.ProductTypeName)
                                                </div>
                                            }

                                            @if (product.PriceOnSell == null)
                                            {
                                                <div class="product-subprice" style="visibility: hidden">@String.Format("{0:0,0} ₫", product.Price)</div>
                                                <div class="product-price">@String.Format("{0:0,0} ₫", product.Price)</div>
                                            }
                                            else
                                            {
                                                <div class="product-subprice">@String.Format("{0:0,0} ₫", product.Price)</div>
                                                <div class="product-price">@String.Format("{0:0,0} ₫", product.PriceOnSell)</div>
                                            }

                                            <div class="product-btn">
                                                <a href="@Url.Action("ProductDetail", "Product", new { ProductId = product.ProductId })">Xem nhanh</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="w-100 text-center d-block">
                            <a class="bran__viewmore d-inline-block" href="">Xem thêm</a>
                        </div>
                    }
                    @if (Model.suggestion.Count == 0)
                    {
                        <div class="w-100 text-center d-block">
                            <a>Chưa có sản phẩm nào phù hợp</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Product image modal -->
<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Đóng</span>
                </button>
                <img src="" class="imagepreview" style="width: 100%;">
            </div>
        </div>
    </div>
</div>
<!-- Mua sỉ modal -->
<div class="modal fade" id="wholesaleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div id="sizechart-modal" class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border: unset;">
                <h5 class="modal-title" id="exampleModalLabel">Bảng giá mua sỉ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body py-0">
                <div class="table-responsive">
                    <table class="table table-bordered order-table" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Số lượng</th>
                                <th>Giảm</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>10 - 20</td>
                                <td>10%</td>
                            </tr>
                            <tr>
                                <td>21 - 30</td>
                                <td>20%</td>
                            </tr>
                            <tr>
                                <td>31 - 40</td>
                                <td>30%</td>
                            </tr>
                            <tr>
                                <td>41 - 50</td>
                                <td>40%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer" style="border: unset;">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Size guide modal -->
<div class="modal fade" id="sizeguideModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true" style="padding-left: 17px !important;">
    <div class="modal-dialog" role="document" style="width: unset !important;">
        <div class="modal-content">
            <div class="modal-header pb-0" style="border: unset;">
                <h5 class="modal-title" id="exampleModalLabel">Hướng dẫn chọn size</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <style type="text/css">
                div.modal-body * {
                    max-width: 100%;
                    height: auto;
                }
            </style>
            <div class="modal-body">
                @Html.Raw(Model.product.SizeGuide)
            </div>
            <div class="modal-footer pt-0" style="border: unset;">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(ViewBag.Message))
{
    <script>
    window.onload = function () {
        alert("@ViewBag.Message");
    };
    </script>
}

<script type="text/javascript">
    var userRepliedId = 0;

    $(document).ready(function () {
        $('.lightSlider').lightSlider({
            gallery: true,
            item: 1,
            loop: true,
            slideMargin: 0,
            thumbItem: 6
        });
        $('.lSSlideOuter .lSPager').css('height', $('.lSSlideOuter .lSPager li').width() + 4)
        $('#content-slider').lightSlider({
            keyPress: false,
            item: 5,
            loop: true
        })
        $('#content-slider').css('height', $('#content-slider li').width())
        $(document).resize(function () {
            $('.lSPager').css('height', $('.lSPager li').width() + 4)
            $('#content-slider').css('height', $('#content-slider li').width())
        })

        @if(ViewBag.isScrolledTo)
        {
            @Html.Raw("scrollToCmt(" + ViewBag.CommentId + ")");
        }
        // Scroll to comment
        function scrollToCmt(id) {
            var node = document.querySelector(`.user-comment-${id}`);
            var yourHeight = $('header').height();
            // scroll to your element
            node.scrollIntoView(true);
            var scrolledY = window.scrollY;
            if (scrolledY) {
                window.scrollTo({ top: scrolledY - yourHeight });
            }
        }
    })
    // View image in large size (open Modal)
    $('.pop').on('click', function () {
        $('.imagepreview').attr('src', $(this).attr('src'));
        $('#imagemodal').modal('show');
    });
    // Feature: upload files
    var arrFiles = [];
    if (window.File && window.FileList && window.FileReader) {
        var filesInput = document.getElementById("image-upload");
        filesInput.addEventListener("change", function (event) {
            var files = event.target.files; //FileList object
            if (files.length > 3)
                return;
            var output = document.getElementById("image-preview");
            $('#image-preview').empty();
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                //Only pics
                if (!file.type.match('image'))
                    continue;

                arrFiles.push(file)

                var picReader = new FileReader();
                picReader.fileName = file.name;
                picReader.addEventListener("load", function (event) {
                    var picFile = event.target;
                    var div = document.createElement("div");
                    div.classList.add(`image__upload-item`);
                    div.innerHTML = "<div class='image-uploaded' style='position: relative; width: 100px; height: 100px; margin-right: 4px'><img src='" + picFile.result + "'" + "title='" + picFile.name + "' style='height: 100%; width: 100%; object-fit: contain'/><span class='remove__upload' style='position: absolute; top: 0; right: 0; cursor: pointer'><svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='red' stroke-width='1' stroke-linecap='round' stroke-linejoin='round' class='feather feather-x'><line x1='18' y1='6' x2='6' y2='18'></line><line x1='6' y1='6' x2='18' y2='18'></line></svg><span></div>";
                    var removeUpload = div.querySelector(".image-uploaded .remove__upload");
                    removeUpload.addEventListener("click", function (evt) {
                        arrFiles.forEach(function (file, index) {
                            if (file.name == event.target.fileName) {
                                arrFiles.splice(index, 1);
                            }
                        })
                        div.remove();
                    });
                    output.insertBefore(div, null);
                });
                //Read the image
                picReader.readAsDataURL(file);
            }
            event.target.value = '';
        });
    }

    arrFilesReply = []
    function handleUpload(event, preview, id = 0) {
        var files = event.target.files;
        var currentFiles = $(`.image__upload-item-${id}`).length + files.length
        if (currentFiles > 3) {
            return;
        }
        var output = document.getElementById(preview);
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            //Only pics
            if (!file.type.match('image'))
                continue;

            arrFilesReply.push(file);
            var picReader = new FileReader();
            picReader.fileName = file.name;
            picReader.addEventListener("load", function (event) {
                var picFile = event.target;
                var div = document.createElement("div");
                div.classList.add(`image__upload-new-item`,`image__upload-item-${id}`, `mr-2`);
                div.innerHTML = `
                    <div class="border mb-2 mx-auto" style="height: 100px; width: 100px;">
                        <div class="image-wrapper w-100 h-100 position-relative d-flex align-items-center justify-content-center">
                            <img class="mw-100 mh-100" src="${picFile.result}" alt="${picFile.name}">
                            <span class="position-absolute remove-upload"
                                style="right: 0; top: 0; cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                    height="18" viewBox="0 0 24 24" fill="none"
                                    stroke="red" stroke-width="1" stroke-linecap="round"
                                    stroke-linejoin="round" class="feather feather-x">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </span>
                        </div>
                    </div>
                `;
                var removeUpload = div.querySelector(".remove-upload");
                removeUpload.addEventListener("click", function (evt) {
                    arrFilesReply.forEach(function (file, index) {
                        if (file.name == event.target.fileName) {
                            arrFilesReply.splice(index, 1);
                        }
                    });
                    div.remove();
                });
                output.insertBefore(div, null);
            });
            //Read the image
            picReader.readAsDataURL(file);
        }
        event.target.value = "";
    }

    // Feature: post comment
    $('.post-comment').click(function () {
        var formData = new FormData();
        for (let i = 0; i < arrFiles.length; i++) {
            formData.append('files', arrFiles[i]);
        }
        formData.append('comment', $('.comment-val').val());
        formData.append('productId', @Model.product.ProductId);
        var value = 0;
        $('.rate-value').each(function(){
            if ($(this).hasClass('checked')) {
                value++;
            }
        })
        formData.append('value', value);

        $.ajax({
            type: "POST",
            url: "/api/RateAPI/PostComment",
            data: formData, // In the controller it receives List<IFormFile> files, ...
            processData: false,
            contentType: false,
            success: function (message) {
                alert(message);
                location.reload();
            },
            error: function (error) {
                alert(error.responseText);
            }
        });
    })

    function sendReply(rateId) {
        var formData = new FormData();
        for (let i = 0; i < arrFilesReply.length; i++) {
            formData.append('files', arrFilesReply[i]);
        }
        formData.append('comment', $(`.rep-comment-val-lv1-${rateId}`).val());
        formData.append('productId', @Model.product.ProductId);
        formData.append('parentId', rateId);
        formData.append('repliedId', rateId);
        formData.append('userRepliedId', userRepliedId);

        AjaxPostForm("/Rate/ReplyComment", formData)
            .success(function (message) {
                alert(message);
                location.reload();
            })
        //$.ajax({
        //    type: "POST",
        //    url: "/Rate/ReplyComment",
        //    data: formData, // In the controller it receives List<IFormFile> files, ...
        //    processData: false,
        //    contentType: false,
        //    success: function (message) {
        //        alert(message);
        //        location.reload();
        //    },
        //    error: function (error) {
        //        alert(error.responseText);
        //    }
        //});
        // renderReplyLv2(id);
    }
    function sendReplyLv2(parentId, replyId) {
        var formData = new FormData();
        for (let i = 0; i < arrFilesReply.length; i++) {
            formData.append('files', arrFilesReply[i]);
        }
        formData.append('comment', $(`.rep-comment-val-lv2-${replyId}`).val());
        formData.append('productId', @Model.product.ProductId);
        formData.append('parentId', parentId);
        formData.append('repliedId', replyId);
        formData.append('userRepliedId', userRepliedId);

        //$.ajax({
        //    type: "POST",
        //    url: "/Rate/ReplyComment",
        //    data: formData, // In the controller it receives List<IFormFile> files, ...
        //    processData: false,
        //    contentType: false,
        //    success: function (message) {
        //        alert(message);
        //        location.reload();
        //    },
        //    error: function (error) {
        //        alert(error.responseText);
        //    }
        //});

        AjaxPostForm("/Rate/ReplyComment", formData)
            .success(function (message) {
                alert(message);
                location.reload();
            })
    }
    function likeComment(rateId) {
        var request = {
            rateId: rateId,
            liked: true,
        }

        PostApi("/Rate/LikeComment", request)
            .then(function (res) {
                $(`.like-${rateId}`).text(res.likeCount);
                $(`.dislike-${rateId}`).text(res.dislikeCount);
                if ($(`.like-svg-${rateId}`).attr('fill') !== 'none') {
                    $(`.like-svg-${rateId}`).attr('fill', 'none');
                } else {
                    $(`.like-svg-${rateId}`).attr('fill', '#288ad9');
                }
                $(`.dislike-svg-${rateId}`).attr('fill', 'none');
            })
    }
    function dislikeComment(rateId) {
        var request = {
            rateId: rateId,
            liked: false,
        }

        PostApi("/Rate/LikeComment", request)
            .then(function (res) {
                $(`.like-${rateId}`).text(res.likeCount);
                $(`.dislike-${rateId}`).text(res.dislikeCount);

                $(`.like-svg-${rateId}`).attr('fill', 'none');
                if ($(`.dislike-svg-${rateId}`).attr('fill') !== 'none') {
                    $(`.dislike-svg-${rateId}`).attr('fill', 'none');
                } else {
                    $(`.dislike-svg-${rateId}`).attr('fill', '#288ad9');
                }
            })
    }
    function deleteComment(id) {
        if (confirm("Xác nhận xóa")) {
            PostApi("/Rate/DeleteComment", { id: id })
                .then(function (res) {
                    alert(res);
                    window.location.reload()
                })
        }
    }
    function updateComment(id) {
        var formData = new FormData();
        formData.append('id', id);
        formData.append('content', $(`.comment-val-${id}`).val());
        var value = 0;
        $(`.rate-value-${id}`).each(function () {
            if ($(this).hasClass('checked')) {
                value++;
            }
        })
        formData.append('rateValue', value);
        for (let i = 0; i < arrFilesReply.length; i++) {
            formData.append('files', arrFilesReply[i]);
        }

        AjaxPostForm("/Rate/UpdateComment", formData)
            .success(function (message) {
                alert(message);
                location.reload();
            });
    }
    function getUsersLike(id) {
        PostApi("/Rate/GetUsersFavor", { id: id, liked: true })
            .then(function (res) {
                if(res && res.data && res.data.length > 0)
                    alert(res.data.join(", "));
            })
    }
    function getUsersDislike(id) {
        PostApi("/Rate/GetUsersFavor", { id: id, liked: false })
            .then(function (res) {
                if (res && res.data && res.data.length > 0)
                    alert(res.data.join(", "));
            })
    }

    // Feature: Add to cart
    $('.btn-addtocart').click(function () {
        // Product and options
        var options = [];
        $('.pro-options').each(function () {
            options.push($(this).val());
        })
        var product = {
            id: @Model.product.ProductId,
            name: '@Model.product.ProductName',
            img: '@if (Model.product.ProductImages.Count > 0) {
                    @Html.Raw(Configuration["ImagePath:Product"] + Model.product.ProductImages[0])
                  } else {
                    @Html.Raw("")
                  }',
            qty: Number($('.pro-qty').val()),
            opts: options,
            type: document.querySelector('input[name="pro-type"]:checked').value
        }

        var cart = JSON.parse(localStorage.getItem("_cart"));
        // create new cart with new product
        if (cart == null) {
            cart = {
                items: [],
                qty: product.qty
            };
            cart.items.push(product);
            // render create new html
        } else {
        // update or add product
            var isExist = false;
            cart.items.forEach(function (item, index) {
                // update product
                if (item.id == product.id && JSON.stringify(item.opts) == JSON.stringify(product.opts) && item.type == product.type) {
                    item.qty = +item.qty + +product.qty;
                    isExist = true;
                }
            })
            // add new
            if (!isExist) {
                cart.items.push(product);
                // render update current
            }
            cart.qty = +cart.qty + +product.qty;
        }

        window.localStorage.setItem("_cart", JSON.stringify(cart));
        renderMiniCart(cart.qty);
        renderProduct(cart.items);
        GetTotal(cart.items);
    })

    // render Html
    function renderReplyLv2(id) {
        $(`.listreply-${id}`).append(htmlReplyLv2());
    }
    function renderMiniCart(qty) {
        $('.minicart .quantity').remove();
        $('.minicart').append(htmlMiniCartQty(qty)); // red icon
        $('.minicart-content').remove();
        $('.cart-action').append(htmlMiniCart(qty)); // mini cart content
    }
    function renderProduct(items) {
        items.forEach(function (item, index) {
            var id = item.id;
            var type = item.type;
            var name = item.name;
            var img = item.img;
            var opts = item.opts;
            var qty = item.qty;
            // call api to get product price by type
            $.get('/api/CartAPI/GetProductPrice', { id: id, type: type }, function (response) {
                var objPrice = {
                    price: response.price,
                    priceOnSell: response.priceOnSell
                }
                // render html
                $('.minicart-products').append(htmlProductInCart(img, name, opts, qty, objPrice, index));
            })
        })
    }
    function GetTotal(items) {
        var request = [];
        items.forEach(function (item) {
            request.push({
                id: item.id,
                typeId: item.type,
                qty: item.qty
            })
        })
        $.ajax({
            url: '/api/CartAPI/getCartTotalPrice',
            data: JSON.stringify(request),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            type: 'POST',
            success: function (data) {
                $('.cart-totalprice').html(`
                    <strong>${new Intl.NumberFormat().format(data)} ₫</strong>
                `)
            },
            error: function (error) {
                console.log('error--',error)
            }
        });
    }

    // Html
    function htmlReplyLv2() {
        var html = `
            <div class="reply mb-2">
                <div class="d-flex align-items-center">
                    <span class="user__comment-name">
                        <strong>Nguyễn Văn A </strong>
                    </span>
                    <span class="user__comment-time ml-2">12:22, 01/11/2021</span>
                </div>
                <div class="comment my-2">
                    <span style="color: #288ad9;">@Html.Raw("@Nguyễn Văn A")</span>
                    Mua cho ck mình lọ này 2 lần rồi, thấy ông bảo lần sau mua cứ
                    mua loại
                    này nhé, công nhận mùi thơm thật sự.
                </div>
                <div class="d-flex align-items-center reply-action">
                    <a href="javascript:void(0)" style="margin-right: 5px; color: #288ad9;">Trả lời</a>
                    <a class="favor" href="javascript:void(0)" style="margin-right: 5px; height: 18px;color: #288ad9;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                height="18" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-thumbs-up">
                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3">
                            </path>
                        </svg>
                    </a>
                    <a class="favor" href="javascript:void(0)" style="margin-right: 5px; height: 18px;color: #288ad9;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18"
                                height="18" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round"
                                class="feather feather-thumbs-down">
                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17">
                            </path>
                        </svg>
                    </a>
                </div>
                <!-- <div class="replybox-lv2">
                    <div class="d-flex">
                        <textarea class="d-flex w-100 mb-2" name="" id="" placeholder="Bình luận">@Html.Raw("@Nguyễn Văn A")</textarea>
                    </div>
                    <div class="text-right">
                        <button type="button" style="background: unset; color: #333 !important;">Hủy</button>
                        <button type="button">Gửi</button>
                    </div>
                </div> -->
            </div>
        `;
        return html;
    }
    function htmlMiniCartQty(qty){
        var html = `
            <span class="quality">${qty}</span>
        `
        return html;
    }
    function htmlMiniCart(qty) {
        var html = `
            <div class="minicart-content">
                <div class="w-100 minicart-quantity">
                    <div class="header-title pb-4 pt-3">Giỏ hàng: ${qty}</div>
                </div>
                <div class="minicart-products filter--scrollbar px-4">

                </div>
                <div class="minicart-totals px-4 pb-3">
                    <div class="d-flex justify-content-between pt-3 pb-4">
                        <div>Tạm tính</div>
                        <div class="total-price cart-totalprice"><strong>120.000.000 ₫</strong></div>
                    </div>
                    <div class="text-center d-block">
                        <a class="minicart-checkout d-inline-block w-100 py-3 mb-4 btn-black" href="">THANH TOÁN</a>
                        <a href=""><u>Xem/Chỉnh sửa</u></a>
                    </div>
                </div>
            </div>
        `;
        return html;
    }
    function htmlProductInCart(img, name, opts, qty, objPrice, index) {
        var price;
        if (!objPrice.priceOnSell) {
            price = `
                <div class="price">${new Intl.NumberFormat().format(objPrice.price)} ₫</div>
                <div class="total-price">
                    ${new Intl.NumberFormat().format(objPrice.price * qty)} ₫
                </div>
            `;
        } else {
            price = `
                <div class="price" style="text-decoration: line-through;">
                    ${new Intl.NumberFormat().format(objPrice.price)} ₫
                </div>
                <div class="price">${new Intl.NumberFormat().format(objPrice.priceOnSell)} ₫</div>
                <div class="total-price">
                    ${new Intl.NumberFormat().format(objPrice.priceOnSell * qty)} ₫
                </div>
            `;
        }
        var options = ``;
        if (opts.length) {
            options = `
                <div class="detail mb-auto">(${opts.join(', ')})</div>
            `
        }
        var html = `
            <div class="minicart-product d-flex py-4">
                <div class="minicart__product-image mr-2">
                    <img class="h-100 w-100" src="${img}" alt="">
                </div>
                <div class="minicart__product-info d-flex flex-column">
                    <div class="name">
                        <strong>${name}</strong>
                    </div>
                    ${options}
                    <div class="amount">x${qty}</div>
                    ${price}
                </div>
                <span class="minicart-remove" value="${index}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1"
                            stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </span>
            </div>
        `;
        return html;
    }
</script>
<!-- Comment -->
<script>
    function openReplyBox(id) {
        arrFilesReply = [];

        hideAllActionList();
        hideAllReply();
        showAllAction();
        hideAllImageNewUpload();
        hideAllUpdateInfoExceptId(id);
        showAllReplyInfoExceptId(id);

        hideAction(id);
        showReply(id);
    }
    function showUpdateBox(id) {
        arrFilesReply = [];

        // Hide current coment's info
        $(`.star-${id}`).removeClass("d-flex");
        $(`.star-${id}`).addClass("d-none");
        $(`.comment-${id}`).addClass("d-none");
        $(`.images-comment-${id}`).addClass("d-none");

        hideAllActionList();
        hideAllReply();
        showAllAction();
        hideAllImageNewUpload();
        hideAllUpdateInfoExceptId(id);
        showAllReplyInfoExceptId(id);

        // Open box
        hideAction(id);
        showUpdate(id);
    }

    function onShowActionList(id) {
        $(`.action-list`).each((index, item) => {
            if (!$(item).hasClass("d-none")) {
                if (!$(item).hasClass(`action-list-${id}`)) {
                    $(item).addClass("d-none");
                }
            }
        })
        if ($(`.action-list-${id}`).hasClass("d-none")) {
            $(`.action-list-${id}`).removeClass("d-none");
        } else {
            $(`.action-list-${id}`).addClass("d-none");
        }
    }
    
    function onCancelUpdate(id) {
        arrFilesReply = [];
        $(`.image__upload-new-item`).remove();

        // Hide current coment's info
        $(`.star-${id}`).removeClass("d-none");
        $(`.star-${id}`).addClass("d-flex");
        $(`.comment-${id}`).removeClass("d-none");
        $(`.images-comment-${id}`).removeClass("d-none");

        // Hide update box
        hideUpdate(id);
        showAction(id);
        hideReply(id);
    }
    function onCancelReply(id) {
        arrFilesReply = [];

        showAction(id);
        hideReply(id);
    }

    // Reply/Update info
    function hideAllUpdateInfoExceptId(id) {
        $(`.update-comment`).each((index, item) => {
            if (!$(item).hasClass(`d-none`)) {
                if (!$(item).hasClass(`update-comment-${id}`)) {
                    $(item).addClass(`d-none`);
                }
            }
        })
    }
    function showAllReplyInfoExceptId(id) {
        $(`.star`).each((index, item) => {
            if ($(item).hasClass(`d-none`)) {
                if (!$(item).hasClass(`star-${id}`)) {
                    $(item).removeClass(`d-none`);
                    $(item).addClass(`d-flex`);
                }
            }
        })
        $(`.comment`).each((index, item) => {
            if ($(item).hasClass(`d-none`)) {
                if (!$(item).hasClass(`comment-${id}`)) {
                    $(item).removeClass(`d-none`);
                }
            }
        })
        $(`.images-comment`).each((index, item) => {
            if ($(item).hasClass(`d-none`)) {
                if (!$(item).hasClass(`images-comment-${id}`)) {
                    $(item).removeClass(`d-none`);
                }
            }
        })
    }

    // Reply
    function showReply(id) {
        $(`.reply-box-${id}`).removeClass('d-none');
    }
    function hideReply(id) {
        $(`.reply-box-${id}`).addClass('d-none');
    }
    function hideAllReply(){
        $(`.reply-box`).each((index, item) => {
            if (!$(item).hasClass('d-none')) {
                $(item).addClass('d-none');
            }
        })
    }

    // Update
    function showUpdate(id) {
        $(`.update-comment-${id}`).removeClass('d-none');
    }
    function hideUpdate(id) {
        $(`.update-comment-${id}`).addClass('d-none');
    }
    function hideAllUpdate(){
        $(`.update-comment`).each((index, item) => {
            if (!$(item).hasClass(`d-none`)) {
                $(item).addClass(`d-none`);
            }
        })
    }

    // Action box
    function showAction(id) {
        $(`.action-box-${id}`).removeClass('d-none');
        $(`.action-box-${id}`).addClass('d-flex');
    }
    function hideAction(id) {
        $(`.action-box-${id}`).removeClass('d-flex');
        $(`.action-box-${id}`).addClass('d-none');
    }
    function hideAllAction(){
        $(`.action-box`).each((index, item) => {
            if (!$(item).hasClass("d-none")) {
                $(item).removeClass("d-flex");
                $(item).addClass("d-none");
            }
        })
    }
    function showAllAction() {
        $(`.action-box`).each((index, item) => {
            if ($(item).hasClass("d-none")) {
                $(item).removeClass("d-none");
                $(item).addClass("d-flex");
            }
        })
    }

    // Action list
    function showActionList(id) {
        $(`.action-list-${id}`).removeClass("d-none");
    }
    function hideActionList(id) {
        $(`.action-list-${id}`).addClass("d-none");
    }
    function hideAllActionList() {
        $(`.action-list`).each((index, item) => {
            if (!$(item).hasClass("d-none")) {
                $(item).addClass("d-none");
            }
        })
    }

    // Image new upload
    function hideAllImageNewUpload() {
        $(`.image__upload-new-item`).each((index, item) => {
            $(item).remove();
        })
    }
    $(`.remove-upload`).click(function () {
        var ele = $(this).parent().parent().parent();
        if (confirm("Xác nhận xóa")) {
            var _id = $(this).attr("value");
            PostApi("/Rate/DeleteImages", { id: _id })
                .then(function (res) {
                    console.log(res);
                    ele.remove();
                    $(`.image-${_id}`).remove();
                })
        }
    })
</script>